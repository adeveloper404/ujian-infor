<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian Harian Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-4 md:p-8 max-w-2xl">

        <!-- Halaman Awal: Input Data Siswa -->
        <div id="halaman-awal" class="bg-white p-8 rounded-xl shadow-lg transition-opacity duration-500">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900">Ujian Harian Online</h1>
                <p class="text-gray-500 mt-2">Silakan isi data diri Anda untuk memulai ujian.</p>
            </div>
            <form id="form-siswa">
                <div class="mb-4">
                    <label for="nama" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="nama" name="nama" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan nama lengkap Anda" required>
                </div>
                <div class="mb-6">
                    <label for="kelas" class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                    <select id="kelas" name="kelas" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Pilih Kelas --</option>
                        <option value="X-1">X-1</option>
                        <option value="X-2">X-2</option>
                        <option value="X-3">X-3</option>
                        <option value="X-4">X-4</option>
                        <option value="XI-2">XI-2</option>
                        <option value="XII-2">XII-2</option>
                        <option value="XII-3">XII-3</option>
                    </select>
                    </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Mulai Ujian</button>
            </form>
        </div>

        <!-- Halaman Ujian -->
        <div id="halaman-ujian" class="hidden transition-opacity duration-500">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <div class="flex justify-between items-center border-b pb-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Soal Ujian</h2>
                        <p id="info-siswa" class="text-sm text-gray-500"></p>
                    </div>
                    <div id="timer" class="text-lg font-bold bg-red-100 text-red-700 px-4 py-2 rounded-lg">60:00</div>
                </div>

                <form id="form-ujian">
                    <!-- Soal 1: Pilihan Ganda -->
                    <div class="mb-8">
                        <p class="font-semibold mb-2">1. Siapakah presiden pertama Republik Indonesia?</p>
                        <div class="space-y-2">
                            <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="soal1" value="A" class="mr-3"> A. Soeharto
                            </label>
                            <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="soal1" value="B" class="mr-3"> B. Soekarno
                            </label>
                            <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="soal1" value="C" class="mr-3"> C. B.J. Habibie
                            </label>
                            <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="soal1" value="D" class="mr-3"> D. Joko Widodo
                            </label>
                        </div>
                    </div>

                    <!-- Soal 2: Isian Singkat -->
                    <div class="mb-8">
                        <p class="font-semibold mb-2">2. Apa nama ibukota negara Indonesia?</p>
                        <input type="text" name="soal2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Jawaban Anda...">
                    </div>

                    <!-- Soal 3: Pilihan Ganda -->
                     <div class="mb-8">
                        <p class="font-semibold mb-2">3. Planet terbesar di tata surya adalah...</p>
                        <div class="space-y-2">
                            <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="soal3" value="A" class="mr-3"> A. Bumi
                            </label>
                            <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="soal3" value="B" class="mr-3"> B. Mars
                            </label>
                            <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="soal3" value="C" class="mr-3"> C. Jupiter
                            </label>
                            <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="soal3" value="D" class="mr-3"> D. Saturnus
                            </label>
                        </div>
                    </div>
                    
                    <!-- Soal 4: Isian Singkat -->
                    <div class="mb-8">
                        <p class="font-semibold mb-2">4. Lagu kebangsaan Indonesia adalah...</p>
                        <input type="text" name="soal4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Jawaban Anda...">
                    </div>


                    <button type="submit" id="submit-button" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300">Kirim Jawaban</button>
                </form>
            </div>
        </div>

        <!-- Halaman Konfirmasi -->
        <div id="halaman-konfirmasi" class="hidden text-center bg-white p-10 rounded-xl shadow-lg">
             <h2 class="text-2xl font-bold text-green-600 mb-4">Terima Kasih!</h2>
             <p id="pesan-konfirmasi" class="text-gray-600">Jawaban Anda telah berhasil dikirim. Silakan tunggu informasi selanjutnya dari guru Anda.</p>
        </div>
    </div>

    <script>
        const halamanAwal = document.getElementById('halaman-awal');
        const halamanUjian = document.getElementById('halaman-ujian');
        const halamanKonfirmasi = document.getElementById('halaman-konfirmasi');
        
        const formSiswa = document.getElementById('form-siswa');
        const formUjian = document.getElementById('form-ujian');
        
        const timerEl = document.getElementById('timer');
        const infoSiswaEl = document.getElementById('info-siswa');
        const submitButton = document.getElementById('submit-button');

        // GANTI DENGAN URL WEB APP GOOGLE SCRIPT ANDA
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxyqT1DiJ_W02UGPqRQuvFq5n2xdJb0hoBIvH1OXLiuEMKLJxLEt9hktNys1OS73XkE9Q/exec'; 

        let timerInterval;
        let waktuSisa = 60 * 60; // 60 menit dalam detik
        let hasLeftPage = false; // Flag untuk mencegah pengiriman berulang

        function formatWaktu(detik) {
            const menit = Math.floor(detik / 60);
            const sisaDetik = detik % 60;
            return `${menit.toString().padStart(2, '0')}:${sisaDetik.toString().padStart(2, '0')}`;
        }

        function mulaiTimer() {
            timerEl.textContent = formatWaktu(waktuSisa);
            timerInterval = setInterval(() => {
                waktuSisa--;
                timerEl.textContent = formatWaktu(waktuSisa);
                if (waktuSisa <= 0) {
                    clearInterval(timerInterval);
                    timerEl.textContent = "Waktu Habis!";
                    timerEl.classList.add('animate-pulse');
                    kirimJawaban(); // Otomatis kirim jika waktu habis
                }
            }, 1000);
        }

        formSiswa.addEventListener('submit', (e) => {
            e.preventDefault();
            const nama = document.getElementById('nama').value;
            const kelas = document.getElementById('kelas').value;

            if (nama && kelas) {
                infoSiswaEl.textContent = `Nama: ${nama} | Kelas: ${kelas}`;
                halamanAwal.classList.add('opacity-0');
                setTimeout(() => {
                    halamanAwal.classList.add('hidden');
                    halamanUjian.classList.remove('hidden');
                    halamanUjian.classList.add('opacity-100');
                    mulaiTimer();
                    // Tambahkan event listener untuk mendeteksi perpindahan tab/halaman
                    document.addEventListener('visibilitychange', handleVisibilityChange);
                }, 500);
            }
        });

        function handleVisibilityChange() {
            // Fungsi ini akan berjalan jika siswa meninggalkan halaman
            if (document.hidden && !hasLeftPage) {
                hasLeftPage = true; // Set flag agar fungsi tidak berjalan lagi
                clearInterval(timerInterval); // Hentikan timer

                // Ubah pesan konfirmasi menjadi pesan diskualifikasi
                const h2Konfirmasi = document.querySelector('#halaman-konfirmasi h2');
                const pKonfirmasi = document.getElementById('pesan-konfirmasi');
                
                h2Konfirmasi.textContent = "Ujian Dihentikan";
                h2Konfirmasi.classList.remove('text-green-600');
                h2Konfirmasi.classList.add('text-red-600');
                pKonfirmasi.innerHTML = "Ujian dihentikan karena Anda meninggalkan halaman. Jawaban terakhir Anda telah dikirim secara otomatis.";

                kirimJawaban(); // Langsung kirim jawaban
            }
        }

        async function kirimJawaban() {
             // Hapus listener agar tidak aktif di halaman konfirmasi
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            
             // Nonaktifkan tombol dan tampilkan status loading
            submitButton.disabled = true;
            submitButton.textContent = 'Mengirim...';
            submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');

            const formData = new FormData(formUjian);
            const nama = document.getElementById('nama').value;
            const kelas = document.getElementById('kelas').value;

            const data = {
                timestamp: new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }),
                nama: nama,
                kelas: kelas,
                jawaban1: formData.get('soal1') || "Tidak dijawab",
                jawaban2: formData.get('soal2') || "Tidak dijawab",
                jawaban3: formData.get('soal3') || "Tidak dijawab",
                jawaban4: formData.get('soal4') || "Tidak dijawab",
            };
            
            try {
                // Jangan mengganti URL ini jika Anda belum punya URL dari Google Apps Script
                if (SCRIPT_URL.includes('AKfycbwX')) {
                     console.log('Data yang akan dikirim:', data);
                     alert("Peringatan: URL Google Apps Script belum diganti. Data hanya akan ditampilkan di console dan tidak akan terkirim ke spreadsheet.");
                } else {
                     const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Penting untuk menghindari error CORS
                        cache: 'no-cache',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                }
                
                // Tampilkan halaman konfirmasi
                halamanUjian.classList.add('opacity-0');
                setTimeout(() => {
                    halamanUjian.classList.add('hidden');
                    halamanKonfirmasi.classList.remove('hidden');
                    halamanKonfirmasi.classList.add('opacity-100');
                }, 500);


            } catch (error) {
                console.error('Error!', error.message);
                alert('Terjadi kesalahan saat mengirim jawaban. Silakan coba lagi.');
                // Aktifkan kembali tombol jika terjadi error
                submitButton.disabled = false;
                submitButton.textContent = 'Kirim Jawaban';
                submitButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
            }
        }

        formUjian.addEventListener('submit', (e) => {
            e.preventDefault();
            clearInterval(timerInterval); // Hentikan timer saat submit manual
            kirimJawaban();
        });

    </script>

</body>
</html>